<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twisted River Farm ‚Äî Row Planner</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --earth: #2c1e0f;
    --loam: #3d2b1a;
    --clay: #5a3e28;
    --sage: #6b8f5e;
    --leaf: #4a7c3f;
    --gold: #d4a843;
    --cream: #f5f0e6;
    --bone: #e8e0d0;
    --parchment: #faf6ed;
    --rust: #b5533e;
    --sky: #5b98b5;
    --panel-bg: rgba(44, 30, 15, 0.95);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--earth);
    color: var(--cream);
    height: 100vh;
    overflow: hidden;
  }

  #map { position: absolute; inset: 0; z-index: 1; }

  /* Crop labels (permanent, vertical) */
  .crop-tooltip {
    background: #ffffff !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
    color: #000000 !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    padding: 3px 6px !important;
    border-radius: 3px !important;
    white-space: nowrap !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4) !important;
    writing-mode: vertical-rl !important;
    text-orientation: mixed !important;
    letter-spacing: 0.5px !important;
    line-height: 1 !important;
  }
  .crop-tooltip::before { display: none !important; }

  /* Lane labels (hover only) */
  .lane-tooltip {
    background: #ffffff !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
    color: #000000 !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    padding: 4px 8px !important;
    border-radius: 3px !important;
    white-space: normal !important;
    min-width: 300px !important;
    max-width: 480px !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4) !important;
  }
  .lane-tooltip::before { display: none !important; }

  /* Side Panel */
  #panel {
    position: fixed; top: 0; right: 0;
    width: 380px; height: 100vh;
    background: var(--panel-bg);
    backdrop-filter: blur(12px);
    z-index: 1000;
    display: flex; flex-direction: column;
    border-left: 1px solid rgba(212, 168, 67, 0.2);
    box-shadow: -4px 0 30px rgba(0,0,0,0.5);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #panel.collapsed { transform: translateX(100%); }

  #panel-toggle {
    position: fixed; top: 16px; right: 16px; z-index: 1001;
    background: var(--panel-bg); border: 1px solid var(--gold); color: var(--gold);
    width: 44px; height: 44px; border-radius: 8px; cursor: pointer;
    font-size: 20px; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  #panel-toggle:hover { background: var(--gold); color: var(--earth); }
  #panel.collapsed ~ #panel-toggle { right: 16px; }
  #panel:not(.collapsed) ~ #panel-toggle { right: 396px; }

  /* Panel header */
  .panel-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid rgba(212, 168, 67, 0.15);
    flex-shrink: 0;
  }

  .panel-title-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
  }

  .panel-header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 28px; color: var(--gold); letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  /* Field selector bar */
  .field-bar {
    display: flex; gap: 6px; align-items: center;
  }

  .field-bar select {
    flex: 1;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(212, 168, 67, 0.3);
    color: var(--cream);
    padding: 6px 10px;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px; font-weight: 600;
    cursor: pointer; outline: none;
  }
  .field-bar select:focus { border-color: var(--gold); }
  .field-bar select option { background: #2c1e0f; color: var(--cream); }

  .field-bar button {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(212, 168, 67, 0.25);
    color: var(--gold);
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    font-size: 14px; font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; justify-content: center;
  }
  .field-bar button:hover {
    background: rgba(212, 168, 67, 0.15);
    border-color: var(--gold);
  }
  .field-bar button.delete-field:hover {
    border-color: var(--rust); color: var(--rust);
  }

  /* Field name row */
  .field-name-row {
    display: flex; gap: 8px; align-items: center; margin-top: 8px;
  }

  .field-name-row label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
    color: var(--gold); opacity: 0.7; flex-shrink: 0;
  }

  .field-name-row input {
    flex: 1;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(212, 168, 67, 0.2);
    color: var(--cream); padding: 5px 10px; border-radius: 6px;
    font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600;
    outline: none;
  }
  .field-name-row input:focus { border-color: var(--gold); }

  /* IO buttons row */
  .io-row {
    display: flex; gap: 6px; margin-top: 8px;
  }

  .io-row button {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(212, 168, 67, 0.2);
    color: var(--gold); padding: 4px 10px; border-radius: 5px;
    cursor: pointer; font-size: 10px; font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    text-transform: uppercase; letter-spacing: 0.8px;
    transition: all 0.2s;
  }
  .io-row button:hover {
    background: rgba(212, 168, 67, 0.15);
    border-color: var(--gold);
  }

  /* NW Point Controls */
  .nw-controls {
    padding: 14px 20px;
    border-bottom: 1px solid rgba(212, 168, 67, 0.15);
    flex-shrink: 0;
  }

  .nw-controls label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px;
    color: var(--gold); opacity: 0.8; display: block; margin-bottom: 6px;
  }

  .nw-inputs {
    display: flex; gap: 8px; align-items: center;
  }

  .nw-inputs input {
    flex: 1;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(212, 168, 67, 0.2);
    color: var(--cream); padding: 7px 10px; border-radius: 6px;
    font-family: 'DM Sans', monospace; font-size: 12px;
    outline: none; transition: border-color 0.2s;
  }
  .nw-inputs input:focus { border-color: var(--gold); }

  .nw-inputs button {
    background: var(--sage); border: none; color: white;
    padding: 7px 12px; border-radius: 6px; cursor: pointer;
    font-size: 11px; font-weight: 600; white-space: nowrap;
    transition: background 0.2s;
  }
  .nw-inputs button:hover { background: var(--leaf); }

  /* Default controls */
  .defaults-bar {
    padding: 12px 20px;
    border-bottom: 1px solid rgba(212, 168, 67, 0.15);
    display: flex; gap: 10px; flex-shrink: 0;
  }

  .default-group { flex: 1; }

  .default-group label {
    font-size: 9px; text-transform: uppercase; letter-spacing: 1px;
    color: var(--bone); opacity: 0.5; display: block; margin-bottom: 3px;
  }

  .default-group input {
    width: 100%;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(212, 168, 67, 0.15);
    color: var(--cream); padding: 5px 8px; border-radius: 5px;
    font-size: 12px; outline: none;
  }
  .default-group input:focus { border-color: var(--gold); }

  /* Row list */
  .row-list { flex: 1; overflow-y: auto; padding: 8px 0; }
  .row-list::-webkit-scrollbar { width: 6px; }
  .row-list::-webkit-scrollbar-track { background: transparent; }
  .row-list::-webkit-scrollbar-thumb { background: rgba(212, 168, 67, 0.25); border-radius: 3px; }

  .row-item {
    padding: 10px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    transition: background 0.15s; cursor: default;
  }
  .row-item:hover { background: rgba(255,255,255,0.03); }

  .row-item-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
  }

  .row-type-badge {
    font-size: 9px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1px; padding: 2px 7px; border-radius: 3px; flex-shrink: 0;
  }
  .row-type-badge.lane { background: rgba(180, 160, 130, 0.25); color: #c8b896; }
  .row-type-badge.crop { background: rgba(74, 124, 63, 0.3); color: #8bc47a; }

  .row-name { font-weight: 600; font-size: 13px; flex: 1; min-width: 0; }
  .row-name.lane-name { color: #c8b896; }
  .row-name.crop-name { color: #8bc47a; }

  .row-controls {
    display: flex; gap: 6px; align-items: center;
  }

  .row-controls select,
  .row-controls input {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--cream); padding: 4px 6px; border-radius: 4px;
    font-size: 11px; font-family: 'DM Sans', sans-serif; outline: none;
  }
  .row-controls select { cursor: pointer; }
  .row-controls select:focus, .row-controls input:focus { border-color: var(--gold); }
  .row-controls input { width: 52px; text-align: center; }
  .row-controls select { width: 70px; }

  .row-dims {
    font-size: 10px; color: var(--bone); opacity: 0.45;
    margin-left: auto; white-space: nowrap;
  }

  .row-actions { display: flex; gap: 4px; }

  .row-actions button {
    background: none;
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--bone); opacity: 0.4;
    width: 24px; height: 24px; border-radius: 4px;
    cursor: pointer; font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .row-actions button:hover { opacity: 1; border-color: var(--gold); color: var(--gold); }
  .row-actions button.delete:hover { border-color: var(--rust); color: var(--rust); }

  .add-row-bar {
    padding: 12px 20px;
    border-top: 1px solid rgba(212, 168, 67, 0.15);
    flex-shrink: 0; display: flex; gap: 8px;
  }

  .add-row-bar button {
    flex: 1; padding: 9px; border-radius: 6px;
    border: 1px dashed rgba(212, 168, 67, 0.3);
    background: rgba(212, 168, 67, 0.05);
    color: var(--gold); cursor: pointer;
    font-size: 12px; font-weight: 600;
    font-family: 'DM Sans', sans-serif; transition: all 0.2s;
  }
  .add-row-bar button:hover {
    background: rgba(212, 168, 67, 0.12); border-color: var(--gold);
  }

  .stats-bar {
    padding: 10px 20px;
    border-top: 1px solid rgba(212, 168, 67, 0.15);
    font-size: 11px; color: var(--bone); opacity: 0.6;
    flex-shrink: 0; display: flex; justify-content: space-between;
  }

  .nw-marker-icon {
    background: var(--gold);
    width: 14px; height: 14px; border-radius: 50%;
    border: 3px solid var(--earth);
    box-shadow: 0 0 0 2px var(--gold), 0 2px 8px rgba(0,0,0,0.5);
  }

  /* Ghost crosshair + dot that follows cursor during placement */
  .nw-marker-ghost {
    position: relative;
    width: 60px; height: 60px;
    pointer-events: none;
  }
  .nw-marker-ghost::before {
    content: '';
    position: absolute;
    left: 50%; top: 50%;
    width: 14px; height: 14px;
    transform: translate(-50%, -50%);
    background: var(--gold);
    border-radius: 50%;
    border: 3px solid var(--earth);
    box-shadow: 0 0 0 3px var(--gold), 0 0 20px 8px rgba(212,168,67,0.6);
    animation: ghostDotPulse 1s ease-in-out infinite;
  }
  .nw-marker-ghost::after {
    content: '';
    position: absolute;
    left: 50%; top: 50%;
    width: 50px; height: 50px;
    transform: translate(-50%, -50%);
    border: 2px solid rgba(212,168,67,0.8);
    border-radius: 50%;
    box-shadow: 0 0 12px 2px rgba(212,168,67,0.3);
    animation: ghostRingPulse 1s ease-in-out infinite;
  }
  .nw-ghost-crosshair-h, .nw-ghost-crosshair-v {
    position: absolute;
    background: rgba(212,168,67,0.7);
    pointer-events: none;
  }
  .nw-ghost-crosshair-h {
    width: 60px; height: 2px;
    left: 0; top: 50%;
    transform: translateY(-50%);
    box-shadow: 0 0 6px rgba(212,168,67,0.4);
  }
  .nw-ghost-crosshair-v {
    width: 2px; height: 60px;
    left: 50%; top: 0;
    transform: translateX(-50%);
    box-shadow: 0 0 6px rgba(212,168,67,0.4);
  }
  @keyframes ghostDotPulse {
    0%, 100% { box-shadow: 0 0 0 3px var(--gold), 0 0 20px 8px rgba(212,168,67,0.6); }
    50%      { box-shadow: 0 0 0 5px rgba(212,168,67,0.8), 0 0 30px 12px rgba(212,168,67,0.4); }
  }
  @keyframes ghostRingPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    50%      { transform: translate(-50%, -50%) scale(1.15); opacity: 0.5; }
  }

  /* Placement mode banner */
  .placement-banner {
    position: fixed;
    top: 20px; left: 50%; transform: translateX(-50%);
    z-index: 2000;
    background: rgba(44, 30, 15, 0.95);
    border: 2px solid var(--gold);
    color: var(--gold);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px; font-weight: 700;
    padding: 12px 28px;
    border-radius: 10px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.6), 0 0 0 1px rgba(212,168,67,0.2);
    letter-spacing: 0.5px;
    animation: bannerFadeIn 0.3s ease-out;
    pointer-events: none;
  }
  @keyframes bannerFadeIn {
    from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    to   { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  /* Hide default cursor during placement */
  .leaflet-container.placing-anchor,
  .leaflet-container.placing-anchor * {
    cursor: none !important;
  }

  .inactive-marker-icon {
    background: rgba(180,160,130,0.6);
    width: 10px; height: 10px; border-radius: 50%;
    border: 2px solid rgba(44,30,15,0.7);
    box-shadow: 0 1px 4px rgba(0,0,0,0.4);
  }

  .row-item.highlight {
    animation: rowHighlight 1.5s ease-out;
  }
  @keyframes rowHighlight {
    0%   { background: rgba(212, 168, 67, 0.35); }
    100% { background: transparent; }
  }

  #import-input { display: none; }

  .dim-tooltip {
    background: #ffffff !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
    color: #000000 !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important; font-weight: 700 !important;
    padding: 3px 7px !important; border-radius: 3px !important;
    white-space: nowrap !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4) !important;
  }
  .dim-tooltip::before { display: none !important; }

  /* Inactive field name tooltip */
  .inactive-field-tooltip {
    background: #ffffff !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
    color: #000000 !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 14px !important; font-weight: 700 !important;
    padding: 5px 12px !important; border-radius: 4px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
  }
  .inactive-field-tooltip::before { display: none !important; }

  /* Permanent inactive field name label */
  .field-name-container {
    font-family: 'DM Sans', sans-serif;
    font-size: 18px;
    font-weight: 800;
    color: #ffffff;
    white-space: nowrap;
    cursor: pointer;
    text-align: center;
    letter-spacing: 0.5px;
    background: rgba(20, 15, 10, 0.9);
    padding: 6px 14px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 3px 12px rgba(0,0,0,0.5);
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    line-height: 1.2;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Planting cards within crop rows */
  .plantings-section {
    margin-top: 6px;
    display: flex; flex-direction: column; gap: 4px;
  }

  .planting-card {
    background: rgba(74, 124, 63, 0.08);
    border: 1px solid rgba(74, 124, 63, 0.2);
    border-left: 3px solid #6b8f5e;
    border-radius: 5px;
    padding: 6px 8px;
  }

  .planting-header {
    display: flex; align-items: center; gap: 6px; margin-bottom: 4px;
  }

  .planting-header input.planting-crop-name {
    flex: 1; min-width: 0;
    background: none; border: none;
    color: #8bc47a; font-size: 12px; font-weight: 600;
    font-family: 'DM Sans', sans-serif; outline: none;
    padding: 2px 4px; border-radius: 3px;
  }
  .planting-header input.planting-crop-name:focus {
    background: rgba(255,255,255,0.06);
  }

  .planting-age {
    font-size: 10px; color: #8bc47a; white-space: nowrap; flex-shrink: 0;
  }

  .planting-header button.delete-planting {
    background: none; border: 1px solid rgba(255,255,255,0.08);
    color: var(--bone); opacity: 0.4;
    width: 20px; height: 20px; border-radius: 3px;
    cursor: pointer; font-size: 10px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .planting-header button.delete-planting:hover {
    opacity: 1; border-color: var(--rust); color: var(--rust);
  }

  .planting-date-row {
    display: flex; align-items: center; gap: 6px; margin-bottom: 4px;
  }

  .planting-date-row label {
    font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--bone); opacity: 0.5; flex-shrink: 0;
  }

  .planting-date-row input[type="date"] {
    flex: 1;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--cream); padding: 2px 5px; border-radius: 4px;
    font-size: 11px; font-family: 'DM Sans', sans-serif;
    outline: none; color-scheme: dark;
  }

  .planting-notes-toggle {
    background: none; border: none;
    color: var(--bone); opacity: 0.5;
    font-size: 9px; font-family: 'DM Sans', sans-serif;
    text-transform: uppercase; letter-spacing: 0.8px;
    cursor: pointer; padding: 2px 0; margin-bottom: 2px;
    transition: opacity 0.15s;
  }
  .planting-notes-toggle:hover { opacity: 0.8; }

  .planting-notes-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
  }

  .planting-note-group {
    display: flex; flex-direction: column; gap: 1px;
  }

  .planting-note-group label {
    font-size: 8px; text-transform: uppercase; letter-spacing: 0.6px;
    color: var(--bone); opacity: 0.45;
  }

  .planting-note-group input {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--cream); padding: 3px 5px; border-radius: 3px;
    font-size: 10px; font-family: 'DM Sans', sans-serif;
    outline: none; width: 100%;
  }
  .planting-note-group input:focus {
    border-color: var(--gold);
  }

  .add-planting-btn {
    background: none;
    border: 1px dashed rgba(74, 124, 63, 0.3);
    color: #6b8f5e; opacity: 0.7;
    font-size: 10px; font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    padding: 3px 8px; border-radius: 4px;
    cursor: pointer; margin-top: 4px;
    transition: all 0.15s;
  }
  .add-planting-btn:hover {
    opacity: 1; border-color: #6b8f5e;
    background: rgba(74, 124, 63, 0.1);
  }

  /* View-date calendar control on map */
  .view-date-control {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    z-index: 1000;
    display: flex; align-items: center; gap: 8px;
    background: rgba(44, 30, 15, 0.92);
    border: 1px solid rgba(212, 168, 67, 0.35);
    padding: 6px 14px; border-radius: 8px;
    box-shadow: 0 3px 16px rgba(0,0,0,0.5);
    font-family: 'DM Sans', sans-serif;
  }
  .view-date-control label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
    color: var(--gold); opacity: 0.8; white-space: nowrap;
  }
  .view-date-control input[type="date"] {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(212, 168, 67, 0.3);
    color: var(--cream); padding: 4px 8px; border-radius: 5px;
    font-size: 12px; font-family: 'DM Sans', sans-serif;
    outline: none; color-scheme: dark;
  }
  .view-date-control input[type="date"]:focus {
    border-color: var(--gold);
  }
  .view-date-control button {
    background: none; border: 1px solid rgba(212, 168, 67, 0.25);
    color: var(--gold); padding: 3px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 600; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    text-transform: uppercase; letter-spacing: 0.6px;
    transition: all 0.15s;
  }
  .view-date-control button:hover {
    background: rgba(212, 168, 67, 0.15);
    border-color: var(--gold);
  }
</style>
</head>
<body>

<div id="map"></div>

<button id="panel-toggle" title="Toggle Panel">‚ò∞</button>
<input type="file" id="import-input" accept=".json" />

<div class="view-date-control">
  <label>üìÖ View as of</label>
  <input type="date" id="view-date-input" />
  <button onclick="resetViewDate()">Today</button>
</div>

<div id="panel">
  <div class="panel-header">
    <div class="panel-title-row">
      <h1>Twisted River Farm</h1>
    </div>

    <div class="field-bar">
      <select id="field-select" onchange="switchField(this.value)"></select>
      <button onclick="addField()" title="New Field">+</button>
      <button class="delete-field" onclick="deleteActiveField()" title="Delete Field">‚úï</button>
    </div>

    <div class="field-name-row">
      <label>Name</label>
      <input type="text" id="field-name" onchange="renameActiveField(this.value)" />
    </div>

    <div class="io-row">
      <button onclick="exportFieldJSON()" title="Export this field as JSON">Export Field</button>
      <button onclick="document.getElementById('import-input').click()" title="Import a field from JSON">Import Field</button>
      <button id="orientation-toggle" onclick="toggleOrientation()" title="Toggle row direction">‚¨ç Vertical</button>
      <button id="toggle-notes-btn" onclick="toggleAllNotes()" title="Expand/Collapse all notes">‚ñ∏ Notes</button>
      <button id="toggle-lanes-btn" onclick="toggleAllLanes()" title="Show/Hide lanes in list">üëÅ Lanes</button>
    </div>
  </div>

  <div class="nw-controls">
    <label>Northwest Anchor Point</label>
    <div class="nw-inputs">
      <input type="text" id="nw-lat" placeholder="Lat" />
      <input type="text" id="nw-lng" placeholder="Lng" />
      <button onclick="updateAnchor()">Set</button>
    </div>
  </div>

  <div class="defaults-bar">
    <div class="default-group">
      <label>Lane Width (ft)</label>
      <input type="number" id="default-lane-width" value="6" min="0.5" step="0.5" onchange="snapshotForUndo();saveState()" />
    </div>
    <div class="default-group">
      <label>Crop Width (ft)</label>
      <input type="number" id="default-crop-width" value="24" min="0.5" step="0.5" onchange="snapshotForUndo();saveState()" />
    </div>
    <div class="default-group">
      <label>Row Length (ft)</label>
      <input type="number" id="default-length" value="250" min="1" step="1" onchange="snapshotForUndo();saveState()" />
    </div>
  </div>

  <div class="row-list" id="row-list"></div>

  <div class="add-row-bar">
    <button onclick="addRow('lane')">+ Lane</button>
    <button onclick="addRow('crop')">+ Crop Row</button>
  </div>

  <div class="stats-bar">
    <span id="stats-count">0 rows</span>
    <span id="stats-width">Total: 0 ft</span>
  </div>
</div>

<script>
// --- Constants ---
const FT_TO_M = 0.3048;
const M_PER_DEG_LAT = 111132.92;
const DEFAULT_NW = { lat: 43.32251614380451, lng: -92.86184191703798 };
const DEFAULT_LANE_WIDTH = 6;
const DEFAULT_CROP_WIDTH = 24;
const DEFAULT_LENGTH = 250;
const STORAGE_KEY = 'twistedriver-rows';

const INITIAL_CROPS = [
  "Spring Brassica A","Spring Brassica B",
  "Onions","Onions","Garlic",
  "Corn","Corn","Corn","Corn","Corn","Corn",
  "Beans","Beans","Potatoes",
  "Yukon+Carrots","Sweet Pot+Beets","Tom/Peppers",
  "Fall Brass","Fall Brass","Fall Brass",
  "Lettuce","Sunflowers","Cantaloupe","Canary","Winter Squash"
];

// --- State ---
let state = loadState();
let undoStack = [];
let placementMode = null;    // { fieldId, ghostMarker, banner, onMove, onClick, onKey }
let viewDate = null;         // null = today (default), or 'YYYY-MM-DD' string
let allNotesExpanded = false;
let lanesHidden = localStorage.getItem('twistedriver-lanesHidden') === 'true';

// --- Map Setup ---
const map = L.map('map', {
  center: getFieldCenter(activeField()),
  zoom: 19,
  maxZoom: 22
});

L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  maxZoom: 22, maxNativeZoom: 21, attribution: '&copy; Google'
}).addTo(map);

let activeLayers = [];     // rects for active field
let activeLabelLayers = []; // label markers for active field
let activeDimLayers = [];  // dim lines for active field
let activeNwMarker = null;
let inactiveLayers = [];   // outlines + markers for other fields

// --- Init ---
populateUI();
renderAll();

// --- View date control ---
document.getElementById('view-date-input').value = todayStr();
document.getElementById('view-date-input').addEventListener('change', function() {
  viewDate = this.value || null;
  renderMap();
});
function resetViewDate() {
  viewDate = null;
  document.getElementById('view-date-input').value = todayStr();
  renderMap();
}

// --- Import handler ---
document.getElementById('import-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const imported = JSON.parse(ev.target.result);
      // Accept either a single field object or old format
      let fieldData;
      if (imported.rows && imported.nw) {
        fieldData = migrateOldField(imported);
      } else {
        alert('Invalid JSON: missing rows or nw fields');
        return;
      }
      // Give it a new id and unique name
      fieldData.id = genId();
      fieldData.name = makeUniqueName(fieldData.name || 'Imported Field');
      state.fields.push(fieldData);
      state.activeFieldId = fieldData.id;
      persist();
      populateUI();
      renderAll();
      zoomToField(fieldData);
    } catch(err) {
      alert('Failed to parse JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

// --- Load / Migration ---
function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      // Already multi-field format ‚Äî migrate rows if needed
      if (parsed.fields && Array.isArray(parsed.fields)) {
        parsed.fields.forEach(f => { f.rows = migrateRowsToPlantings(f.rows); });
        return parsed;
      }
      // Old single-field format ‚Üí migrate
      if (parsed.rows && parsed.nw) {
        const field = migrateOldField(parsed);
        return { activeFieldId: field.id, fields: [field] };
      }
    } catch(e) {}
  }
  return buildInitialState();
}

function migrateOldField(old) {
  return {
    id: old.id || genId(),
    name: old.name || 'Field 1',
    nw: old.nw,
    defaultLaneWidth: old.defaultLaneWidth || DEFAULT_LANE_WIDTH,
    defaultCropWidth: old.defaultCropWidth || DEFAULT_CROP_WIDTH,
    defaultLength: old.defaultLength || DEFAULT_LENGTH,
    rows: migrateRowsToPlantings(old.rows)
  };
}

function migrateRowsToPlantings(rows) {
  return rows.map(row => {
    if (row.type !== 'crop') return row;
    if (row.plantings) return row; // already migrated
    const planting = {
      id: genId(),
      cropName: row.name || 'New Crop',
      plantDate: row.plantDate || null,
      notes: row.notes || null,
      fertilityNotes: null, harvestData: null, treatments: null
    };
    const migrated = { ...row, plantings: [planting] };
    delete migrated.plantDate;
    delete migrated.notes;
    return migrated;
  });
}

function buildInitialState() {
  const field = buildDefaultField('Field 1');
  return { activeFieldId: field.id, fields: [field] };
}

function buildDefaultField(name) {
  const rows = [];
  const counts = {};
  const totals = {};
  INITIAL_CROPS.forEach(c => { totals[c] = (totals[c] || 0) + 1; });

  INITIAL_CROPS.forEach((cropName, i) => {
    rows.push({
      id: genId(), type: 'lane', name: `Lane ${i + 1}`,
      width: DEFAULT_LANE_WIDTH, length: DEFAULT_LENGTH,
      widthOverride: false, lengthOverride: false
    });

    let label = cropName;
    if (totals[cropName] > 1) {
      counts[cropName] = (counts[cropName] || 0) + 1;
      label = `${cropName} ${counts[cropName]}`;
    }

    rows.push({
      id: genId(), type: 'crop', name: label,
      width: DEFAULT_CROP_WIDTH, length: DEFAULT_LENGTH,
      widthOverride: false, lengthOverride: false,
      plantings: [{
        id: genId(), cropName: label,
        plantDate: null, notes: null,
        fertilityNotes: null, harvestData: null, treatments: null
      }]
    });
  });

  rows.push({
    id: genId(), type: 'lane', name: `Lane ${INITIAL_CROPS.length + 1}`,
    width: DEFAULT_LANE_WIDTH, length: DEFAULT_LENGTH,
    widthOverride: false, lengthOverride: false
  });

  return {
    id: genId(),
    name: name,
    nw: { ...DEFAULT_NW },
    defaultLaneWidth: DEFAULT_LANE_WIDTH,
    defaultCropWidth: DEFAULT_CROP_WIDTH,
    defaultLength: DEFAULT_LENGTH,
    rows
  };
}

// --- Helpers ---
function genId() {
  return 'f' + Math.random().toString(36).substring(2, 10);
}

function activeField() {
  return state.fields.find(f => f.id === state.activeFieldId) || state.fields[0];
}

function makeUniqueName(baseName) {
  const names = state.fields.map(f => f.name);
  if (!names.includes(baseName)) return baseName;
  let i = 2;
  while (names.includes(`${baseName} ${i}`)) i++;
  return `${baseName} ${i}`;
}

function persist() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function snapshotForUndo() {
  undoStack.push(JSON.stringify(state));
  if (undoStack.length > 50) undoStack.shift(); // cap memory
}

function undo() {
  if (undoStack.length === 0) return;
  state = JSON.parse(undoStack.pop());
  persist();
  populateUI();
  renderAll();
}

document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
    e.preventDefault();
    undo();
  }
});

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function getDaysAge(plantDate) {
  if (!plantDate) return null;
  const planted = new Date(plantDate + 'T00:00:00');
  const today = new Date();
  today.setHours(0,0,0,0);
  const diff = Math.floor((today - planted) / 86400000);
  return diff;
}

function getPlantingAsOfDate(row) {
  if (!row.plantings || row.plantings.length === 0) return null;
  const cutoff = viewDate || todayStr();
  // Find plantings on or before the view date
  const eligible = row.plantings.filter(p => p.plantDate && p.plantDate <= cutoff);
  if (eligible.length > 0) {
    return eligible.reduce((a, b) => a.plantDate > b.plantDate ? a : b);
  }
  // If nothing planted yet as of cutoff, show the earliest future planting
  const future = row.plantings.filter(p => p.plantDate && p.plantDate > cutoff);
  if (future.length > 0) {
    return future.reduce((a, b) => a.plantDate < b.plantDate ? a : b);
  }
  return row.plantings[row.plantings.length - 1];
}

function getLatestPlanting(row) {
  if (!row.plantings || row.plantings.length === 0) return null;
  const withDate = row.plantings.filter(p => p.plantDate);
  if (withDate.length > 0) {
    return withDate.reduce((a, b) => a.plantDate > b.plantDate ? a : b);
  }
  return row.plantings[row.plantings.length - 1];
}

function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

// --- Geo helpers ---
function mPerDegLng(lat) {
  return 111320 * Math.cos(lat * Math.PI / 180);
}
function ftToLatDeg(ft) {
  return (ft * FT_TO_M) / M_PER_DEG_LAT;
}
function ftToLngDeg(ft, lat) {
  return (ft * FT_TO_M) / mPerDegLng(lat);
}
function isVertical(field) {
  return (field.orientation || 'vertical') === 'vertical';
}
function getFieldCenter(field) {
  if (!field || !field.rows || field.rows.length === 0) return [field.nw.lat, field.nw.lng];
  const totalWidth = field.rows.reduce((s, r) => s + r.width, 0);
  const maxLength = Math.max(...field.rows.map(r => r.length));
  if (isVertical(field)) {
    return [
      field.nw.lat - ftToLatDeg(maxLength / 2),
      field.nw.lng + ftToLngDeg(totalWidth / 2, field.nw.lat)
    ];
  } else {
    return [
      field.nw.lat - ftToLatDeg(totalWidth / 2),
      field.nw.lng + ftToLngDeg(maxLength / 2, field.nw.lat)
    ];
  }
}
function getFieldBounds(field) {
  if (!field.rows || field.rows.length === 0) return null;
  const totalWidth = field.rows.reduce((s, r) => s + r.width, 0);
  const maxLength = Math.max(...field.rows.map(r => r.length));
  if (isVertical(field)) {
    return [
      [field.nw.lat, field.nw.lng],
      [field.nw.lat - ftToLatDeg(maxLength), field.nw.lng + ftToLngDeg(totalWidth, field.nw.lat)]
    ];
  } else {
    return [
      [field.nw.lat, field.nw.lng],
      [field.nw.lat - ftToLatDeg(totalWidth), field.nw.lng + ftToLngDeg(maxLength, field.nw.lat)]
    ];
  }
}

// --- Field management ---
function switchField(id) {
  state.activeFieldId = id;
  persist();
  populateUI();
  renderAll();
  zoomToField(activeField());
}

function addField() {
  // If already placing, cancel the previous placement
  if (placementMode) cancelPlacement();

  const name = makeUniqueName('Field ' + (state.fields.length + 1));
  const fieldId = genId();

  // Create ghost crosshair marker at map center (will follow mouse)
  const center = map.getCenter();
  const ghostMarker = L.marker([center.lat, center.lng], {
    icon: L.divIcon({
      className: 'nw-marker-ghost',
      html: '<div class="nw-ghost-crosshair-h"></div><div class="nw-ghost-crosshair-v"></div>',
      iconSize: [60, 60], iconAnchor: [30, 30]
    }),
    interactive: false, zIndexOffset: 2000
  }).addTo(map);

  // Show placement banner
  const banner = document.createElement('div');
  banner.className = 'placement-banner';
  banner.textContent = 'üìç Click on the map to place the anchor point ‚Äî Esc to cancel';
  document.body.appendChild(banner);

  // Set cursor hidden (custom crosshair replaces it)
  map.getContainer().classList.add('placing-anchor');

  // Mouse-move handler: ghost follows cursor
  function onMove(e) {
    ghostMarker.setLatLng(e.latlng);
  }

  // Use native click on the map container so clicks aren't eaten by Leaflet layers
  const container = map.getContainer();
  function onPlacementClick(e) {
    // Only handle left-click
    if (e.button !== 0) return;
    // Convert pixel position to lat/lng
    const rect = container.getBoundingClientRect();
    const point = L.point(e.clientX - rect.left, e.clientY - rect.top);
    const latlng = map.containerPointToLatLng(point);

    // Clean up placement UI FIRST so it doesn't interfere with render
    cleanupPlacement();

    // Defer field creation to next frame so Leaflet finishes its event cycle
    setTimeout(function() {
      const field = {
        id: fieldId,
        name: name,
        nw: { lat: latlng.lat, lng: latlng.lng },
        defaultLaneWidth: DEFAULT_LANE_WIDTH,
        defaultCropWidth: DEFAULT_CROP_WIDTH,
        defaultLength: DEFAULT_LENGTH,
        rows: []
      };
      state.fields.push(field);
      state.activeFieldId = field.id;
      persist();
      populateUI();
      renderAll();
    }, 0);
  }

  // Escape key: cancel
  function onKey(e) {
    if (e.key === 'Escape') cancelPlacement();
  }

  map.on('mousemove', onMove);
  container.addEventListener('click', onPlacementClick, true); // capture phase
  document.addEventListener('keydown', onKey);

  placementMode = { fieldId, ghostMarker, banner, onMove, onPlacementClick, onKey, container };
}

function cleanupPlacement() {
  if (!placementMode) return;
  map.off('mousemove', placementMode.onMove);
  placementMode.container.removeEventListener('click', placementMode.onPlacementClick, true);
  document.removeEventListener('keydown', placementMode.onKey);
  map.removeLayer(placementMode.ghostMarker);
  placementMode.banner.remove();
  map.getContainer().classList.remove('placing-anchor');
  placementMode = null;
}

function cancelPlacement() {
  cleanupPlacement();
}

function deleteActiveField() {
  if (state.fields.length <= 1) {
    alert('Cannot delete the last field.');
    return;
  }
  const field = activeField();
  if (!confirm(`Delete field "${field.name}" and all its rows?`)) return;
  state.fields = state.fields.filter(f => f.id !== field.id);
  state.activeFieldId = state.fields[0].id;
  persist();
  populateUI();
  renderAll();
  zoomToField(activeField());
}

function renameActiveField(newName) {
  activeField().name = newName;
  persist();
  // Update dropdown text without full re-render
  const opt = document.querySelector(`#field-select option[value="${state.activeFieldId}"]`);
  if (opt) opt.textContent = newName;
  renderMap(); // update inactive field tooltips
}

function zoomToField(field) {
  const center = getFieldCenter(field);
  map.setView(center, map.getZoom());
}

// --- UI Population ---
function populateUI() {
  const field = activeField();

  // Field dropdown
  const sel = document.getElementById('field-select');
  sel.innerHTML = state.fields.map(f =>
    `<option value="${f.id}" ${f.id === state.activeFieldId ? 'selected' : ''}>${escHtml(f.name)}</option>`
  ).join('');

  // Field name
  document.getElementById('field-name').value = field.name;

  // NW
  document.getElementById('nw-lat').value = field.nw.lat;
  document.getElementById('nw-lng').value = field.nw.lng;

  // Defaults
  document.getElementById('default-lane-width').value = field.defaultLaneWidth;
  document.getElementById('default-crop-width').value = field.defaultCropWidth;
  document.getElementById('default-length').value = field.defaultLength;

  // Orientation toggle
  const isVert = (field.orientation || 'vertical') === 'vertical';
  document.getElementById('orientation-toggle').textContent = isVert ? '‚¨ç Vertical' : '‚¨å Horizontal';

  // Lanes toggle button state
  const lanesBtn = document.getElementById('toggle-lanes-btn');
  lanesBtn.textContent = lanesHidden ? 'üëÅ‚Äçüó® Lanes' : 'üëÅ Lanes';
  lanesBtn.style.opacity = lanesHidden ? '0.5' : '1';
}

// --- State mutations (all operate on active field) ---
function saveState() {
  const field = activeField();
  field.defaultLaneWidth = parseFloat(document.getElementById('default-lane-width').value) || DEFAULT_LANE_WIDTH;
  field.defaultCropWidth = parseFloat(document.getElementById('default-crop-width').value) || DEFAULT_CROP_WIDTH;
  field.defaultLength = parseFloat(document.getElementById('default-length').value) || DEFAULT_LENGTH;

  field.rows.forEach(r => {
    if (!r.widthOverride) {
      r.width = r.type === 'lane' ? field.defaultLaneWidth : field.defaultCropWidth;
    }
    if (!r.lengthOverride) {
      r.length = field.defaultLength;
    }
  });

  persist();
  renderAll();
}

function updateAnchor() {
  const lat = parseFloat(document.getElementById('nw-lat').value);
  const lng = parseFloat(document.getElementById('nw-lng').value);
  if (!isNaN(lat) && !isNaN(lng)) {
    snapshotForUndo();
    activeField().nw = { lat, lng };
    saveState();
    map.setView(getFieldCenter(activeField()), map.getZoom());
  }
}

function addRow(type) {
  snapshotForUndo();
  const field = activeField();
  const name = type === 'lane'
    ? `Lane ${field.rows.filter(r => r.type === 'lane').length + 1}`
    : `New Crop`;
  const row = {
    id: genId(), type, name,
    width: type === 'lane' ? field.defaultLaneWidth : field.defaultCropWidth,
    length: field.defaultLength,
    widthOverride: false, lengthOverride: false
  };
  if (type === 'crop') {
    row.plantings = [{
      id: genId(), cropName: name,
      plantDate: null, notes: null,
      fertilityNotes: null, harvestData: null, treatments: null
    }];
  }
  field.rows.push(row);
  saveState();
}

function deleteRow(id) {
  snapshotForUndo();
  const field = activeField();
  field.rows = field.rows.filter(r => r.id !== id);
  saveState();
}

function moveRow(id, dir) {
  snapshotForUndo();
  const field = activeField();
  const idx = field.rows.findIndex(r => r.id === id);
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= field.rows.length) return;
  [field.rows[idx], field.rows[newIdx]] = [field.rows[newIdx], field.rows[idx]];
  saveState();
}

function updateRowField(id, field, value) {
  snapshotForUndo();
  const af = activeField();
  const row = af.rows.find(r => r.id === id);
  if (!row) return;

  if (field === 'name') {
    row.name = value;
  } else if (field === 'type') {
    row.type = value;
    if (!row.widthOverride) {
      row.width = value === 'lane' ? af.defaultLaneWidth : af.defaultCropWidth;
    }
    if (value === 'crop' && !row.plantings) {
      row.plantings = [{
        id: genId(), cropName: row.name,
        plantDate: null, notes: null,
        fertilityNotes: null, harvestData: null, treatments: null
      }];
    }
  } else if (field === 'width') {
    const v = parseFloat(value);
    if (!isNaN(v) && v > 0) { row.width = v; row.widthOverride = true; }
  } else if (field === 'length') {
    const v = parseFloat(value);
    if (!isNaN(v) && v > 0) { row.length = v; row.lengthOverride = true; }
  }
  saveState();
}

function addPlanting(rowId) {
  snapshotForUndo();
  const row = activeField().rows.find(r => r.id === rowId);
  if (!row || row.type !== 'crop') return;
  if (!row.plantings) row.plantings = [];
  row.plantings.push({
    id: genId(), cropName: 'New Crop',
    plantDate: null, notes: null,
    fertilityNotes: null, harvestData: null, treatments: null
  });
  saveState();
}

function deletePlanting(rowId, plantingId) {
  snapshotForUndo();
  const row = activeField().rows.find(r => r.id === rowId);
  if (!row || !row.plantings) return;
  if (row.plantings.length <= 1) return; // keep at least one
  row.plantings = row.plantings.filter(p => p.id !== plantingId);
  // Update row name to latest planting
  const latest = getLatestPlanting(row);
  if (latest) row.name = latest.cropName;
  saveState();
}

function updatePlanting(rowId, plantingId, field, value) {
  snapshotForUndo();
  const row = activeField().rows.find(r => r.id === rowId);
  if (!row || !row.plantings) return;
  const planting = row.plantings.find(p => p.id === plantingId);
  if (!planting) return;

  if (field === 'cropName') {
    planting.cropName = value;
    // Update row name to latest planting's crop name
    const latest = getLatestPlanting(row);
    if (latest) row.name = latest.cropName;
  } else if (field === 'plantDate') {
    planting.plantDate = value || null;
    // Re-evaluate latest planting for row name
    const latest = getLatestPlanting(row);
    if (latest) row.name = latest.cropName;
  } else if (field === 'notes') {
    planting.notes = value || null;
    persist(); renderMap(); return;
  } else if (field === 'fertilityNotes') {
    planting.fertilityNotes = value || null;
    persist(); renderMap(); return;
  } else if (field === 'harvestData') {
    planting.harvestData = value || null;
    persist(); renderMap(); return;
  } else if (field === 'treatments') {
    planting.treatments = value || null;
    persist(); renderMap(); return;
  }
  saveState();
}

function toggleOrientation() {
  snapshotForUndo();
  const field = activeField();
  field.orientation = (field.orientation || 'vertical') === 'vertical' ? 'horizontal' : 'vertical';
  persist();
  populateUI();
  renderAll();
}

// --- Export / Import ---
function exportFieldJSON() {
  const field = activeField();
  const blob = new Blob([JSON.stringify(field, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const safeName = field.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
  a.download = `twisted-river-${safeName}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// --- Render ---
function renderAll() {
  renderList();
  renderMap();
  updateStats();
}

function updateStats() {
  const field = activeField();
  const totalWidth = field.rows.reduce((s, r) => s + r.width, 0);
  const cropArea = field.rows.filter(r => r.type === 'crop').reduce((s, r) => s + r.width * r.length, 0);
  document.getElementById('stats-count').textContent =
    `${field.rows.length} rows (${field.rows.filter(r=>r.type==='crop').length} crop)`;
  document.getElementById('stats-width').textContent =
    `Width: ${totalWidth.toFixed(1)} ft ¬∑ Crop area: ${(cropArea / 43560).toFixed(2)} ac`;
}

function renderList() {
  const field = activeField();
  const container = document.getElementById('row-list');
  container.innerHTML = field.rows.map((row, idx) => `
    <div class="row-item" data-id="${row.id}">
      <div class="row-item-header">
        <span class="row-type-badge ${row.type}">${row.type}</span>
        <input
          class="row-name ${row.type === 'lane' ? 'lane-name' : 'crop-name'}"
          value="${escHtml(row.name)}"
          onchange="updateRowField('${row.id}', 'name', this.value)"
          style="background:none;border:none;font-size:13px;font-weight:600;font-family:inherit;color:inherit;outline:none;flex:1;min-width:0;padding:2px 4px;border-radius:3px;"
          onfocus="this.style.background='rgba(255,255,255,0.06)'"
          onblur="this.style.background='none'"
        />
        <div class="row-actions">
          <button onclick="moveRow('${row.id}', -1)" title="Move up">‚ñ≤</button>
          <button onclick="moveRow('${row.id}', 1)" title="Move down">‚ñº</button>
          <button class="delete" onclick="deleteRow('${row.id}')" title="Delete">‚úï</button>
        </div>
      </div>
      <div class="row-controls">
        <select onchange="updateRowField('${row.id}', 'type', this.value)">
          <option value="lane" ${row.type === 'lane' ? 'selected' : ''}>Lane</option>
          <option value="crop" ${row.type === 'crop' ? 'selected' : ''}>Crop</option>
        </select>
        <label style="font-size:10px;color:var(--bone);opacity:0.5;">W</label>
        <input type="number" value="${row.width}" min="0.5" step="0.5"
          onchange="updateRowField('${row.id}', 'width', this.value)"
          style="${row.widthOverride ? 'border-color: var(--gold);' : ''}"
          title="Width (ft)" />
        <label style="font-size:10px;color:var(--bone);opacity:0.5;">L</label>
        <input type="number" value="${row.length}" min="1" step="1"
          onchange="updateRowField('${row.id}', 'length', this.value)"
          style="${row.lengthOverride ? 'border-color: var(--gold);' : ''}"
          title="Length (ft)" />
        <span class="row-dims">${row.width}√ó${row.length} ft</span>
      </div>
      ${row.type === 'crop' && row.plantings ? `<div class="plantings-section">
        ${row.plantings.map((p, pi) => `<div class="planting-card">
          <div class="planting-header">
            <input class="planting-crop-name" value="${escHtml(p.cropName)}"
              onchange="updatePlanting('${row.id}', '${p.id}', 'cropName', this.value)"
              placeholder="Crop name" />
            ${(() => { const age = getDaysAge(p.plantDate); return age !== null ? '<span class="planting-age">' + age + 'd</span>' : ''; })()}
            ${row.plantings.length > 1 ? `<button class="delete-planting" onclick="deletePlanting('${row.id}', '${p.id}')" title="Remove planting">‚úï</button>` : ''}
          </div>
          <div class="planting-date-row">
            <label>Planted</label>
            <input type="date" value="${p.plantDate || ''}"
              onchange="updatePlanting('${row.id}', '${p.id}', 'plantDate', this.value)" />
          </div>
          <button class="planting-notes-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'grid' : 'none'; this.textContent = this.nextElementSibling.style.display === 'none' ? '‚ñ∏ Notes' : '‚ñæ Notes'">‚ñ∏ Notes</button>
          <div class="planting-notes-grid" style="display:none;">
            <div class="planting-note-group">
              <label>General</label>
              <input type="text" value="${escHtml(p.notes || '')}" placeholder="‚Äî"
                onchange="updatePlanting('${row.id}', '${p.id}', 'notes', this.value)" />
            </div>
            <div class="planting-note-group">
              <label>Fertility</label>
              <input type="text" value="${escHtml(p.fertilityNotes || '')}" placeholder="‚Äî"
                onchange="updatePlanting('${row.id}', '${p.id}', 'fertilityNotes', this.value)" />
            </div>
            <div class="planting-note-group">
              <label>Harvest</label>
              <input type="text" value="${escHtml(p.harvestData || '')}" placeholder="‚Äî"
                onchange="updatePlanting('${row.id}', '${p.id}', 'harvestData', this.value)" />
            </div>
            <div class="planting-note-group">
              <label>Treatments</label>
              <input type="text" value="${escHtml(p.treatments || '')}" placeholder="‚Äî"
                onchange="updatePlanting('${row.id}', '${p.id}', 'treatments', this.value)" />
            </div>
          </div>
        </div>`).join('')}
        <button class="add-planting-btn" onclick="addPlanting('${row.id}')">+ Add Planting</button>
      </div>` : ''}
    </div>
  `).join('');

  // Re-apply toggle states after DOM rebuild
  if (allNotesExpanded) {
    container.querySelectorAll('.planting-notes-grid').forEach(g => g.style.display = 'grid');
    container.querySelectorAll('.planting-notes-toggle').forEach(t => t.textContent = '‚ñæ Notes');
  }
  if (lanesHidden) {
    container.querySelectorAll('.row-item').forEach(item => {
      const badge = item.querySelector('.row-type-badge');
      if (badge && badge.classList.contains('lane')) item.style.display = 'none';
    });
  }
}

function renderMap() {
  // Clear all layers
  activeLayers.forEach(r => map.removeLayer(r));
  activeLabelLayers.forEach(r => map.removeLayer(r));
  activeDimLayers.forEach(r => map.removeLayer(r));
  inactiveLayers.forEach(r => map.removeLayer(r));
  activeLayers = [];
  activeLabelLayers = [];
  activeDimLayers = [];
  inactiveLayers = [];
  if (activeNwMarker) { map.removeLayer(activeNwMarker); activeNwMarker = null; }

  // Draw INACTIVE fields first (outlines, dimmed, clickable)
  state.fields.forEach(field => {
    if (field.id === state.activeFieldId) return;
    renderInactiveField(field);
  });

  // Draw ACTIVE field
  const field = activeField();
  renderActiveField(field);
}

function renderInactiveField(field) {
  if (!field.rows || field.rows.length === 0) {
    // Just draw a small marker at NW
    const m = L.marker([field.nw.lat, field.nw.lng], {
      icon: L.divIcon({
        className: 'inactive-marker-icon',
        iconSize: [10, 10], iconAnchor: [5, 5]
      })
    }).addTo(map);
    m.bindTooltip(field.name, {
      permanent: false, direction: 'top', className: 'inactive-field-tooltip'
    });
    m.on('click', function() { switchField(field.id); });
    inactiveLayers.push(m);
    return;
  }

  const bounds = getFieldBounds(field);
  if (!bounds) return;

  // Draw a single outline rectangle for the whole field
  const rect = L.rectangle(bounds, {
    color: 'rgba(200, 180, 140, 0.5)',
    weight: 2,
    dashArray: '8,5',
    fillColor: 'rgba(180, 160, 130, 0.7)',
    fillOpacity: 1,
    opacity: 0.8
  }).addTo(map);

  rect.bindTooltip(field.name, {
    permanent: false, direction: 'top', className: 'inactive-field-tooltip'
  });
  rect.on('click', function() { switchField(field.id); });
  inactiveLayers.push(rect);

  // Permanent field name label at center
  const center = getFieldCenter(field);
  const fieldName = escHtml(field.name);
  // Approximate size: 11px per char + padding, 36px height
  const nameWidth = Math.max(80, fieldName.length * 11 + 28);
  const nameLabel = L.marker(center, {
    icon: L.divIcon({
      className: 'field-name-container',
      html: fieldName,
      iconSize: [nameWidth, 36],
      iconAnchor: [nameWidth / 2, 18]
    }),
    interactive: true
  }).addTo(map);
  nameLabel.on('click', function() { switchField(field.id); });
  inactiveLayers.push(nameLabel);

  // Small marker at NW corner
  const m = L.marker([field.nw.lat, field.nw.lng], {
    icon: L.divIcon({
      className: 'inactive-marker-icon',
      iconSize: [10, 10], iconAnchor: [5, 5]
    })
  }).addTo(map);
  m.on('click', function() { switchField(field.id); });
  inactiveLayers.push(m);
}

function renderActiveField(field) {
  // NW draggable marker
  activeNwMarker = L.marker([field.nw.lat, field.nw.lng], {
    icon: L.divIcon({
      className: 'nw-marker-icon',
      iconSize: [14, 14], iconAnchor: [7, 7]
    }),
    draggable: true, zIndexOffset: 1000
  }).addTo(map);

  activeNwMarker.on('dragend', function(e) {
    snapshotForUndo();
    const pos = e.target.getLatLng();
    field.nw = { lat: pos.lat, lng: pos.lng };
    document.getElementById('nw-lat').value = pos.lat.toFixed(14);
    document.getElementById('nw-lng').value = pos.lng.toFixed(14);
    saveState();
  });

  // Draw rows
  const vert = isVertical(field);
  let offsetFt = 0;

  field.rows.forEach((row) => {
    let northLat, southLat, westLng, eastLng;

    if (vert) {
      // Vertical: rows stack west‚Üíeast, each row runs north‚Üísouth
      westLng = field.nw.lng + ftToLngDeg(offsetFt, field.nw.lat);
      eastLng = field.nw.lng + ftToLngDeg(offsetFt + row.width, field.nw.lat);
      northLat = field.nw.lat;
      southLat = field.nw.lat - ftToLatDeg(row.length);
    } else {
      // Horizontal: rows stack north‚Üísouth, each row runs west‚Üíeast
      northLat = field.nw.lat - ftToLatDeg(offsetFt);
      southLat = field.nw.lat - ftToLatDeg(offsetFt + row.width);
      westLng = field.nw.lng;
      eastLng = field.nw.lng + ftToLngDeg(row.length, field.nw.lat);
    }

    const bounds = [[northLat, westLng], [southLat, eastLng]];
    const isLane = row.type === 'lane';
    const color = isLane ? '#b0a080' : '#5eaa4e';
    const fillColor = isLane
      ? 'rgba(180, 160, 130, 0.30)'
      : 'rgba(74, 160, 55, 0.35)';

    const rect = L.rectangle(bounds, {
      color, weight: 1, fillColor, fillOpacity: 1, opacity: 0.7
    }).addTo(map);

    if (isLane) {
      rect.bindTooltip(row.name, {
        permanent: false, direction: 'center', className: 'lane-tooltip'
      });
    } else {
      const centerLat = (northLat + southLat) / 2;
      const centerLng = (westLng + eastLng) / 2;
      const latest = getPlantingAsOfDate(row);
      const labelName = latest ? latest.cropName : row.name;
      const age = latest ? getDaysAge(latest.plantDate) : null;
      const ageStr = age !== null ? ` (${age}d)` : '';
      const labelMarker = L.marker([centerLat, centerLng], {
        icon: L.divIcon({
          className: '',
          html: `<div style="
            position: absolute;
            ${vert ? 'left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(180deg); writing-mode: vertical-rl; text-orientation: mixed;'
                   : 'left: 50%; top: 50%; transform: translate(-50%, -50%);'}
            font-family: 'DM Sans', sans-serif;
            font-size: 14px; font-weight: 700;
            color: #000000;
            white-space: nowrap; pointer-events: none;
            letter-spacing: 0.3px;
            background: #ffffff;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            line-height: 1;
          ">${escHtml(labelName)}&nbsp;&nbsp;&nbsp;&nbsp;${ageStr}</div>`,
          iconSize: [0, 0], iconAnchor: [0, 0]
        }),
        interactive: false
      }).addTo(map);
      activeLabelLayers.push(labelMarker);

      // Hover tooltip showing all plantings with all notes
      const tipParts = [];
      if (row.plantings) {
        row.plantings.forEach(p => {
          const lines = [];
          if (p.cropName) lines.push('<b>' + escHtml(p.cropName) + '</b>');
          if (p.plantDate) {
            const pAge = getDaysAge(p.plantDate);
            lines.push('Planted: ' + p.plantDate + (pAge !== null ? ' (' + pAge + 'd)' : ''));
          }
          if (p.notes) lines.push('<b>Notes:</b> ' + escHtml(p.notes));
          if (p.fertilityNotes) lines.push('<b>Fertility:</b> ' + escHtml(p.fertilityNotes));
          if (p.harvestData) lines.push('<b>Harvest:</b> ' + escHtml(p.harvestData));
          if (p.treatments) lines.push('<b>Treatments:</b> ' + escHtml(p.treatments));
          if (lines.length) tipParts.push(lines.join('<br>'));
        });
      }
      if (tipParts.length) {
        const sep = row.plantings.length > 1 ? '<br><hr style="border:none;border-top:1px solid rgba(0,0,0,0.15);margin:3px 0;"><br>' : '';
        rect.bindTooltip(tipParts.join(sep), {
          permanent: false, direction: 'top', className: 'lane-tooltip',
          offset: [0, -10]
        });
      }
    }

    rect.on('click', function() { scrollToRow(row.id); });

    activeLayers.push(rect);
    offsetFt += row.width;
  });

  renderDimensions(field, offsetFt);
}

function renderDimensions(field, totalWidthFt) {
  if (field.rows.length === 0) return;

  const maxLength = Math.max(...field.rows.map(r => r.length));
  const vert = isVertical(field);

  if (vert) {
    // Width line across top (horizontal), length line down left (vertical)
    const topLat = field.nw.lat + ftToLatDeg(3);
    const rightLng = field.nw.lng + ftToLngDeg(totalWidthFt, field.nw.lat);
    const widthLine = L.polyline([[topLat, field.nw.lng], [topLat, rightLng]], {
      color: '#d4a843', weight: 2, dashArray: '6,4', opacity: 0.7
    }).addTo(map);
    widthLine.bindTooltip(`${totalWidthFt.toFixed(1)} ft`, {
      permanent: true, direction: 'top', className: 'dim-tooltip', offset: [0, -4]
    });
    activeDimLayers.push(widthLine);

    const leftLng = field.nw.lng - ftToLngDeg(3, field.nw.lat);
    const bottomLat = field.nw.lat - ftToLatDeg(maxLength);
    const lengthLine = L.polyline([[field.nw.lat, leftLng], [bottomLat, leftLng]], {
      color: '#d4a843', weight: 2, dashArray: '6,4', opacity: 0.7
    }).addTo(map);
    lengthLine.bindTooltip(`${maxLength.toFixed(0)} ft`, {
      permanent: true, direction: 'left', className: 'dim-tooltip', offset: [-4, 0]
    });
    activeDimLayers.push(lengthLine);
  } else {
    // Width line down left (vertical, stacking direction), length line across top (horizontal)
    const leftLng = field.nw.lng - ftToLngDeg(3, field.nw.lat);
    const bottomLat = field.nw.lat - ftToLatDeg(totalWidthFt);
    const widthLine = L.polyline([[field.nw.lat, leftLng], [bottomLat, leftLng]], {
      color: '#d4a843', weight: 2, dashArray: '6,4', opacity: 0.7
    }).addTo(map);
    widthLine.bindTooltip(`${totalWidthFt.toFixed(1)} ft`, {
      permanent: true, direction: 'left', className: 'dim-tooltip', offset: [-4, 0]
    });
    activeDimLayers.push(widthLine);

    const topLat = field.nw.lat + ftToLatDeg(3);
    const rightLng = field.nw.lng + ftToLngDeg(maxLength, field.nw.lat);
    const lengthLine = L.polyline([[topLat, field.nw.lng], [topLat, rightLng]], {
      color: '#d4a843', weight: 2, dashArray: '6,4', opacity: 0.7
    }).addTo(map);
    lengthLine.bindTooltip(`${maxLength.toFixed(0)} ft`, {
      permanent: true, direction: 'top', className: 'dim-tooltip', offset: [0, -4]
    });
    activeDimLayers.push(lengthLine);
  }
}

// --- Scroll to row in panel ---
function scrollToRow(rowId) {
  // Open panel if collapsed
  document.getElementById('panel').classList.remove('collapsed');
  const el = document.querySelector(`.row-item[data-id="${rowId}"]`);
  if (!el) return;
  // Un-hide if lanes are hidden
  if (el.style.display === 'none') el.style.display = '';
  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  el.classList.remove('highlight');
  // Force reflow to restart animation
  void el.offsetWidth;
  el.classList.add('highlight');
}

// --- Toggle All Notes ---
function toggleAllNotes() {
  allNotesExpanded = !allNotesExpanded;
  const btn = document.getElementById('toggle-notes-btn');
  btn.textContent = allNotesExpanded ? '‚ñæ Notes' : '‚ñ∏ Notes';
  document.querySelectorAll('.planting-notes-grid').forEach(grid => {
    grid.style.display = allNotesExpanded ? 'grid' : 'none';
  });
  document.querySelectorAll('.planting-notes-toggle').forEach(toggle => {
    toggle.textContent = allNotesExpanded ? '‚ñæ Notes' : '‚ñ∏ Notes';
  });
}

// --- Toggle All Lanes ---
function toggleAllLanes() {
  lanesHidden = !lanesHidden;
  localStorage.setItem('twistedriver-lanesHidden', lanesHidden);
  const btn = document.getElementById('toggle-lanes-btn');
  btn.textContent = lanesHidden ? 'üëÅ‚Äçüó® Lanes' : 'üëÅ Lanes';
  btn.style.opacity = lanesHidden ? '0.5' : '1';
  document.querySelectorAll('.row-item').forEach(item => {
    const badge = item.querySelector('.row-type-badge');
    if (badge && badge.classList.contains('lane')) {
      item.style.display = lanesHidden ? 'none' : '';
    }
  });
}

// Panel toggle
document.getElementById('panel-toggle').addEventListener('click', function() {
  document.getElementById('panel').classList.toggle('collapsed');
});
</script>
</body>
</html>
